<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å¹¸ç¦æ•™é¤Šï½œé›¶ç”¨éŒ¢ç·´åŠŸæˆ¿ v1.6.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #0a0a0a; color: #e5e7eb; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .card-dark { background: #161616; border-radius: 1.5rem; padding: 1.25rem; border: 1px solid #262626; }
        .input-dark-field { width: 100%; background: #000; border: 2px solid #333; border-radius: 1rem; padding: 0.8rem; color: white; outline: none; transition: 0.3s; }
        .input-dark-field:focus { border-color: #f97316; }
        .btn-orange-dark { background: linear-gradient(135deg, #f97316, #ea580c); color: white; border-radius: 1.25rem; font-weight: 900; transition: 0.2s; }
        .btn-orange-dark:active { scale: 0.95; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; color: #525252; transition: 0.2s; background: none; border: none; }
        .tab-active { color: #f97316; font-weight: 900; }
        .mode-btn { padding: 0.6rem; border-radius: 0.8rem; background: #262626; color: #a3a3a3; font-size: 11px; border: 1px solid transparent; }
        .mode-active { background: rgba(249, 115, 22, 0.1); color: #f97316; border-color: #f97316; }
        .hidden { display: none !important; }
        .progress-bar { transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }
    </style>
</head>
<body class="pb-28">

<div class="p-4 flex justify-between items-center bg-[#161616] sticky top-0 z-50 h-24 border-b border-gray-800 backdrop-blur-md">
    <div>
        <p class="text-[10px] text-gray-500 font-bold uppercase tracking-widest">Captain Logic</p>
        <select id="roleSwitch" onchange="switchRole(this.value)" class="bg-black text-orange-500 font-black outline-none border-none cursor-pointer text-base">
            <option value="child">ğŸ‘¶ å…’ç«¥ç·´åŠŸæ¨¡å¼</option>
            <option value="parent">âš™ï¸ å®¶é•·ç®¡ç†ä¸­å¿ƒ</option>
        </select>
    </div>
    <div class="flex gap-4 font-black">
        <span class="text-orange-500 text-lg">ğŸ’° $<span id="balanceDisplay">0</span></span>
        <span class="text-blue-400 text-lg">ğŸ’ <span id="pointsDisplay">0</span>P</span>
    </div>
</div>

<main class="p-4 max-w-md mx-auto">
    <section id="page-info" class="page-content space-y-4">
        <h1 class="text-2xl font-black text-orange-500 italic uppercase text-center">å¹¸ç¦æ•™é¤Šï½œé›¶ç”¨éŒ¢ç·´åŠŸæˆ¿</h1>
        <div class="card-dark border-l-4 border-orange-500 bg-orange-950/5">
            <h2 class="font-black text-orange-400 mb-2">ğŸ’¡ é›¶ç”¨éŒ¢ç·´åŠŸæˆ¿åŠŸèƒ½</h2>
            <div class="text-gray-400 text-xs leading-relaxed space-y-2">
                <p>é€™æ˜¯ä¸€å€‹ç·´ç¿’ã€Œç†æ™ºæ¶ˆè²»ã€çš„å®‰å…¨ç©ºé–“ã€‚é›¶ç”¨éŒ¢æ˜¯è³‡æºåˆ†é…çš„ç·´ç¿’å·ï¼Œä¸¦éçå‹µæˆ–è–ªæ°´ã€‚</p>
                <ul class="list-disc ml-4 space-y-1">
                    <li><span class="text-white">éœ€è¦ï¼š</span>ç”Ÿæ´»å¿…éœ€å“ã€‚</li>
                    <li><span class="text-white">æƒ³è¦ï¼š</span>ç›®å‰çš„æ…¾æœ›ã€‚</li>
                    <li><span class="text-blue-400 font-bold">é¡˜æœ›ï¼š</span>è·¨æœŸå­µåŒ–çš„å¤§å‹å¤¢æƒ³ã€‚</li>
                </ul>
                <p>é€é <span class="text-orange-400">30ç§’å†·éœæœŸ</span> è¨“ç·´å‰é¡è‘‰ï¼Œè®“ç†æ™ºéšŠé•·æ¥ç®¡é‡‘éŒ¢ä¸»æ¬Šã€‚</p>
            </div>
        </div>
        <div class="card-dark border-l-4 border-blue-500">
            <h2 class="font-black text-blue-400 mb-2">ğŸ“² å®‰è£è‡³ä¸»ç•«é¢</h2>
            <div class="text-gray-400 text-xs bg-black/50 p-3 rounded-lg border border-gray-800">
                <p class="text-white font-bold mb-1">iOS Safariï¼š</p>
                <p class="mb-2">åˆ†äº«åœ–ç¤º â†’ ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</p>
                <p class="text-white font-bold mb-1">Android Chromeï¼š</p>
                <p>ä¸‰é»é¸å–® â†’ ã€Œå®‰è£æ‡‰ç”¨ç¨‹å¼ã€</p>
            </div>
        </div>
    </section>

    <section id="page-vault" class="page-content hidden space-y-4">
        <div class="card-dark text-center py-8 bg-gradient-to-b from-[#1a1a1a] to-[#0f0f0f] border-b-4 border-orange-600 shadow-2xl">
            <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Available Balance</p>
            <p class="text-7xl font-black text-white mb-4">$<span id="v-bal">0</span></p>
            <div class="flex justify-center gap-3 text-xs">
                <span class="bg-blue-900/20 px-4 py-1 rounded-full text-blue-400 border border-blue-900/50">å„²å­˜èƒ½é‡: $<span id="v-saved">0</span></span>
                <span class="bg-orange-900/20 px-4 py-1 rounded-full text-orange-400 border border-orange-900/50">å¯ç”¨é»æ•¸: <span id="v-pts">0</span>P</span>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <div class="card-dark flex flex-col justify-center items-center py-4 border-purple-900/50">
                <p class="text-[10px] text-gray-500 font-bold uppercase">Settlement</p>
                <p class="text-purple-400 font-black text-sm my-1" id="v-date">æœªè¨­å®šæ—¥æœŸ</p>
                <button onclick="checkUnboxPermission()" class="mt-1 bg-purple-600 px-4 py-1.5 rounded-xl text-white font-black text-xs">é–‹ç®±çµç®—</button>
            </div>
            <button onclick="playGacha()" class="card-dark border-2 border-blue-900 bg-blue-900/10 flex flex-col items-center justify-center py-4">
                <span class="text-2xl mb-1">ğŸ¡</span>
                <span class="font-black text-blue-400 text-xs italic">èƒ½é‡æ‰­è›‹ (1P)</span>
            </button>
        </div>

        <div class="space-y-2">
            <h3 class="text-[10px] text-gray-500 font-black px-2 uppercase tracking-widest">Recent Activity</h3>
            <div id="historyList" class="space-y-2"></div>
        </div>
    </section>

    <section id="page-practice" class="page-content hidden">
        <div class="card-dark text-center p-6 flex flex-col justify-center min-h-[400px]">
            <div id="step-input" class="space-y-4">
                <h2 class="text-xl font-black text-orange-400 italic tracking-tighter uppercase">Captain Practice</h2>
                <input type="text" id="itemName" class="input-dark-field text-center" placeholder="è¼¸å…¥ä¿®ç·´é …ç›®">
                <input type="number" id="itemPrice" class="input-dark-field text-4xl font-black text-center py-4" placeholder="$">
                <button onclick="startCooldown()" class="btn-orange-dark w-full py-5 text-xl shadow-lg">ğŸ§˜ å•Ÿå‹• 30s å†·éœæœŸ</button>
                <button onclick="quickSettle()" class="w-full py-2 text-gray-600 text-xs underline font-bold">âœ… è¨ˆç•«æ€§è³¼è²· (ç›´æ¥è¨˜éŒ„)</button>
            </div>
            <div id="step-cooldown" class="hidden">
                <div id="timerNum" class="text-9xl font-black text-orange-500 my-8 animate-pulse">30</div>
                <p class="text-gray-500 italic tracking-widest font-bold">æ·±å‘¼å¸ï¼Œç†æ™ºæ­£åœ¨é€£çµ...</p>
            </div>
            <div id="step-decision" class="hidden space-y-6">
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="setMode('éœ€è¦', this)" class="mode-btn">éœ€è¦</button>
                    <button onclick="setMode('æƒ³è¦', this)" class="mode-btn">æƒ³è¦</button>
                    <button onclick="setMode('é¡˜æœ›', this)" class="mode-btn border-blue-500/50 text-blue-400">âœ¨ é¡˜æœ›æ± </button>
                </div>
                <button id="save-energy-btn" onclick="saveDecision(false)" class="btn-orange-dark w-full py-5 text-xl">çœä¸‹ä¾†ï¼Œå„²å­˜èƒ½é‡ï¼</button>
                <button onclick="saveDecision(true)" class="w-full text-gray-500 text-sm underline font-bold">æˆ‘æ±ºå®šè³¼è²· (æ‰£é™¤é¤˜é¡)</button>
            </div>
        </div>
    </section>

    <section id="page-wish" class="page-content hidden space-y-4">
        <h2 class="text-center text-2xl font-black text-blue-400 italic uppercase">Wish Pool</h2>
        <div class="text-center text-[10px] text-gray-500 mb-4 px-6">â€» é€™è£¡çš„å¤¢æƒ³ä¸å—é–‹ç®±çµç®—å½±éŸ¿ï¼ŒæœƒæŒçºŒç´¯ç©ç›´è‡³é”æˆã€‚</div>
        <div id="wishList" class="space-y-4"></div>
    </section>

    <section id="page-settings" class="page-content hidden">
        <div id="parent-settings" class="hidden space-y-4 text-xs font-bold">
            <div class="card-dark border-2 border-purple-900/50 space-y-4">
                <h2 class="font-black text-purple-500 text-center text-lg uppercase">Parent Control</h2>
                <div><label class="text-gray-500">Google å›é¥‹è¡¨å–®é€£çµ</label><input type="text" id="setFormUrl" class="input-dark-field mt-1 text-blue-400"></div>
                <div><label class="text-gray-500">ä¸‹ä¸€é–‹ç®±æ—¥æœŸ</label><input type="date" id="setUnboxDate" class="input-dark-field mt-1"></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-gray-500">åŠ ç¢¼åˆ©æ¯ %</label><input type="number" id="setInterest" class="input-dark-field mt-1"></div>
                    <div><label class="text-gray-500">åˆ©æ¯ä¸Šé™ $</label><input type="number" id="setLimit" class="input-dark-field mt-1"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-gray-500">è£œå……å¯ç”¨é¤˜é¡ $</label><input type="number" id="setBalance" class="input-dark-field mt-1"></div>
                    <div><label class="text-gray-500">1P åŒ¯ç‡ (çœä¸‹å¹¾å…ƒæ›1P)</label><input type="number" id="setRate" class="input-dark-field mt-1"></div>
                </div>
                <div><label class="text-gray-500">æ‰­è›‹çé … (ç”¨ã€Œã€ã€åˆ†éš”)</label><textarea id="poolInput" class="input-dark-field h-20 mt-1"></textarea></div>
                <button onclick="saveSettings()" class="btn-orange-dark w-full py-4 mt-2">ğŸ’¾ åŒæ­¥ä¿®ç·´è³‡æ–™</button>
            </div>
            <button onclick="resetAllData()" class="w-full py-3 text-red-900 text-xs opacity-50 underline">é‡ç½®ç³»çµ± (æ¸…é™¤æ‰€æœ‰ç´€éŒ„)</button>
        </div>
        <div id="child-lock-msg" class="text-center p-20 text-gray-700 font-bold italic text-xl">ğŸ”’ å®¶é•·é–å®šä¸­</div>
    </section>
</main>

<div id="unbox-modal" class="fixed inset-0 bg-black/95 z-[100] hidden flex flex-col p-6">
    <div id="settle-screen" class="flex-grow flex flex-col justify-center text-center space-y-8">
        <h2 class="text-4xl font-black text-purple-500 italic uppercase">Unbox Day!</h2>
        <div class="card-dark space-y-4 border-purple-500/50 py-8">
            <div class="flex justify-between text-lg"><span>æ’²æ»¿é¤˜é¡:</span><span class="text-white">$<span id="m-bal">0</span></span></div>
            <div class="flex justify-between text-lg text-green-400 border-b border-gray-800 pb-4">
                <span>åŠ ç¢¼åˆ©æ¯ (<span id="m-rate">0</span>%):</span><span>+$<span id="m-bonus">0</span></span>
            </div>
            <div class="flex justify-between text-3xl font-black text-yellow-500 pt-4"><span>æ‡‰é ˜ç¾é‡‘:</span><span>$<span id="m-total">0</span></span></div>
        </div>
        <p class="text-gray-500 text-xs">é»æ“Šç¢ºèªå¾Œï¼Œæ’²æ»¿é¤˜é¡èˆ‡æ­·å²æ—¥èªŒå°‡æ­¸é›¶ã€‚<br><span class="text-blue-400 font-bold">é¡˜æœ›æ± é€²åº¦å°‡è¢«ä¿ç•™è‡³ä¸‹ä¸€æœŸã€‚</span></p>
        <div class="space-y-3">
            <button onclick="finalSettle()" class="w-full bg-purple-600 text-white py-5 rounded-3xl font-black text-xl shadow-2xl">ç¢ºèªçµç®—ä¸¦ç™¼æ”¾ç¾é‡‘</button>
            <button onclick="$('unbox-modal').classList.add('hidden')" class="text-gray-600 text-sm underline">å…ˆç­‰ç­‰ï¼Œæˆ‘é‚„æ²’æº–å‚™å¥½</button>
        </div>
    </div>
    <div id="feedback-screen" class="hidden flex-grow flex flex-col justify-center text-center space-y-10">
        <div class="text-8xl animate-bounce">ğŸ†</div>
        <h2 class="text-4xl font-black text-yellow-500 italic">MISSION CLEAR</h2>
        <p class="text-gray-400 leading-relaxed px-10">æœ¬æœŸä¿®ç·´åœ“æ»¿å®Œæˆï¼è«‹èˆ‡å­©å­ä¸€èµ·å¡«å¯«å•å·ï¼Œå›é¡§é€™é€±çš„é€²æ­¥ï¼š</p>
        <button onclick="window.open(state.formUrl || 'https://forms.gle/A7c4bhmMzp9sdvWA7', '_blank')" class="btn-orange-dark w-full py-6 text-xl font-black border-2 border-yellow-400 shadow-2xl">ğŸ“ å¡«å¯«ä¿®ç·´å›é¥‹</button>
        <button onclick="location.reload()" class="text-gray-600 text-sm underline italic">å›åˆ°ä¸»ç•«é¢é–‹å•Ÿæ–°çš„ä¸€æœŸ</button>
    </div>
</div>

<nav class="fixed bottom-0 w-full bg-[#161616] border-t border-gray-800 flex justify-around p-4 h-28 z-50 backdrop-blur-md">
    <button onclick="showPage('info')" class="nav-item tab-active" id="nav-info">ğŸ“–<span class="text-[10px] mt-1 font-bold">èªªæ˜</span></button>
    <button onclick="showPage('vault')" class="nav-item" id="nav-vault">ğŸ¯<span class="text-[10px] mt-1 font-bold">é‡‘åº«</span></button>
    <button onclick="showPage('practice')" class="nav-item" id="nav-practice">ğŸ§˜<span class="text-[10px] mt-1 font-bold">ç·´åŠŸ</span></button>
    <button onclick="showPage('wish')" class="nav-item" id="nav-wish">âœ¨<span class="text-[10px] mt-1 font-bold">é¡˜æœ›æ± </span></button>
    <button onclick="showPage('settings')" class="nav-item" id="nav-settings">âš™ï¸<span class="text-[10px] mt-1 font-bold">ç®¡ç†</span></button>
</nav>

<script>
    const STORAGE_KEY = "hp_v162_stable_final";
    const $ = (id) => document.getElementById(id);

    let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
        role: "child", balance: 0, savedAmount: 0, gachaCount: 0,
        interestRate: 10, interestLimit: 100, unboxDate: "", pointsPerP: 100,
        formUrl: "https://forms.gle/A7c4bhmMzp9sdvWA7",
        logs: [], wishes: [], 
        gachaPool: ["æ™šç¡ 15 åˆ†é˜", "é¡å¤–é›¶å˜´åˆ¸", "çœ‹é›»è¦– 20 åˆ†é˜", "å…æ´—ç¢—ä¸€æ¬¡", "æŒ‘é¸æ™šé¤æ¬Š"]
    };

    function save() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        updateUI();
    }

    function updateUI() {
        const currentP = Math.max(0, Math.floor(state.savedAmount / (state.pointsPerP || 100)) - state.gachaCount);
        $('balanceDisplay').innerText = state.balance;
        $('pointsDisplay').innerText = currentP;
        $('v-bal').innerText = state.balance;
        $('v-pts').innerText = currentP;
        $('v-saved').innerText = state.savedAmount;
        $('v-date').innerText = state.unboxDate || "æœªè¨­å®š";

        $('parent-settings').classList.toggle('hidden', state.role !== "parent");
        $('child-lock-msg').classList.toggle('hidden', state.role === "parent");

        renderHistory();
        renderWishes();
    }

    // æ ¸å¿ƒé‚è¼¯ï¼šçµç®—æ™‚ã€Œåªã€æ¸…é™¤é¤˜é¡èˆ‡æ—¥èªŒï¼Œä¿ç•™é¡˜æœ›æ± èˆ‡é»æ•¸åŒ¯ç‡
    window.finalSettle = () => {
        const bonus = Math.min(Math.floor(state.balance * (state.interestRate / 100)), state.interestLimit);
        const totalAward = state.balance + bonus;
        
        // é‡ç½®æ•¸æ“š
        state.balance = 0;
        state.savedAmount = 0;
        state.gachaCount = 0;
        state.logs = [{
            time: new Date().toLocaleDateString(),
            name: "ğŸ† é€±æœŸåœ“æ»¿é‡ç½®",
            mode: "å®Œè³½",
            val: `+${totalAward}`,
            color: "text-purple-400"
        }];
        // state.wishes é™£åˆ—æœªè®Šå‹•ï¼Œé”æˆè·¨æœŸå­µåŒ–
        
        save();
        confetti({ particleCount: 200, spread: 90, origin: { y: 0.6 } });
        $('settle-screen').classList.add('hidden');
        $('feedback-screen').classList.remove('hidden');
    };

    window.checkUnboxPermission = () => {
        if (state.role !== 'parent') return alert("çµç®—æ¬Šé™åƒ…é™å®¶é•·ã€‚");
        const bonus = Math.min(Math.floor(state.balance * (state.interestRate / 100)), state.interestLimit);
        $('m-bal').innerText = state.balance;
        $('m-rate').innerText = state.interestRate;
        $('m-bonus').innerText = bonus;
        $('m-total').innerText = state.balance + bonus;
        $('settle-screen').classList.remove('hidden');
        $('feedback-screen').classList.add('hidden');
        $('unbox-modal').classList.remove('hidden');
    };

    window.saveDecision = (buy) => {
        if (!state.lastMode) return alert("è«‹é¸æ“‡åˆ†é¡ï¼šéœ€è¦/æƒ³è¦/é¡˜æœ›");
        const p = parseInt($('itemPrice').value);
        const n = $('itemName').value;

        if (buy) {
            if (state.balance < p) return alert("æ’²æ»¿é¤˜é¡ä¸è¶³å–”ï¼");
            state.balance -= p;
            state.logs.unshift({ time: new Date().toLocaleDateString(), name: n, mode: `è¡å‹•:${state.lastMode}`, val: `-$${p}`, color: "text-red-500" });
        } else {
            if (state.lastMode === 'é¡˜æœ›') {
                state.wishes.unshift({ name: n, price: p, saved: 0, id: Date.now() });
                state.logs.unshift({ time: new Date().toLocaleDateString(), name: `âœ¨æ–°é¡˜æœ›:${n}`, mode: "é¡˜æœ›", val: `$${p}`, color: "text-blue-400" });
            } else {
                state.savedAmount += p;
                state.logs.unshift({ time: new Date().toLocaleDateString(), name: n, mode: `çœä¸‹:${state.lastMode}`, val: `+$${p}`, color: "text-blue-400" });
            }
            confetti({ particleCount: 150 });
        }
        save();
        resetPractice();
    };

    window.injectMoney = (id) => {
        const wishIndex = state.wishes.findIndex(w => w.id === id);
        const wish = state.wishes[wishIndex];
        const need = wish.price - wish.saved;
        const amt = parseInt(prompt(`ç›®å‰æ’²æ»¿å‰© $${state.balance}ï¼Œè¦å­˜å¤šå°‘åˆ°ã€${wish.name}ã€‘ï¼Ÿ\né‚„å·® $${need} é”æˆã€‚`));
        
        if (isNaN(amt) || amt <= 0 || state.balance < amt) return alert("é‡‘é¡ç„¡æ•ˆæˆ–é¤˜é¡ä¸è¶³");
        
        state.balance -= amt;
        state.wishes[wishIndex].saved += amt;
        
        state.logs.unshift({ time: new Date().toLocaleDateString(), name: `å­µåŒ–:${wish.name}`, mode: "å­˜æ¬¾", val: `-$${amt}`, color: "text-blue-500" });
        
        if (state.wishes[wishIndex].saved >= wish.price) {
            confetti({ particleCount: 200, spread: 70 });
            alert(`ğŸ‰ æ­å–œï¼é¡˜æœ›ã€${wish.name}ã€‘å­µåŒ–æˆåŠŸï¼`);
        }
        save();
    };

    window.quickSettle = () => {
        const p = parseInt($('itemPrice').value);
        const n = $('itemName').value;
        if (!p || !n) return alert("è«‹å¡«å¯«å…§å®¹");
        if (state.balance < p) return alert("æ’²æ»¿é¤˜é¡ä¸è¶³");
        state.balance -= p;
        state.logs.unshift({ time: new Date().toLocaleDateString(), name: `(è¨ˆç•«)${n}`, mode: "ç›´æ¥æ‰£æ¬¾", val: `-$${p}`, color: "text-gray-500" });
        save();
        resetPractice();
    };

    window.startCooldown = () => {
        if (!$('itemPrice').value || !$('itemName').value) return alert("è«‹å®Œæ•´å¡«å¯«é …ç›®èˆ‡é‡‘é¡");
        $('step-input').classList.add('hidden');
        $('step-cooldown').classList.remove('hidden');
        let t = 30;
        const timer = setInterval(() => {
            t--;
            $('timerNum').innerText = t;
            if (t <= 0) {
                clearInterval(timer);
                $('step-cooldown').classList.add('hidden');
                $('step-decision').classList.remove('hidden');
            }
        }, 1000);
    };

    window.playGacha = () => {
        const currentP = Math.floor(state.savedAmount / (state.pointsPerP || 100)) - state.gachaCount;
        if (currentP < 1) return alert("é»æ•¸èƒ½é‡ä¸è¶³ï¼Œå¤šç·´ç¿’å†·éœå§ï¼");
        const prize = state.gachaPool[Math.floor(Math.random() * state.gachaPool.length)];
        state.gachaCount++;
        save();
        alert(`ğŸŠ æ­å–œæŠ½ä¸­çå‹µï¼šã€${prize}ã€‘\nè«‹æ‰¾å®¶é•·å…Œæ›å–”ï¼`);
    };

    window.saveSettings = () => {
        state.balance = parseInt($('setBalance').value) || state.balance;
        state.pointsPerP = parseInt($('setRate').value) || 100;
        state.interestRate = parseInt($('setInterest').value) || 0;
        state.interestLimit = parseInt($('setLimit').value) || 0;
        state.unboxDate = $('setUnboxDate').value;
        state.formUrl = $('setFormUrl').value;
        if ($('poolInput').value) state.gachaPool = $('poolInput').value.split(/[ã€,]/);
        save();
        alert("æ•™é¤Šè³‡æ–™å·²åŒæ­¥ï¼");
    };

    window.setMode = (m, btn) => {
        state.lastMode = m;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('mode-active'));
        btn.classList.add('mode-active');
        $('save-energy-btn').innerText = (m === 'é¡˜æœ›') ? "âœ¨ å»ºç«‹é¡˜æœ›é …ç›®" : "æ±ºå®šçœä¸‹ï¼Œè½‰åŒ–èƒ½é‡ï¼";
    };

    window.showPage = (id) => {
        document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
        $('page-' + id).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('tab-active'));
        $('nav-' + id).classList.add('tab-active');
        if (id === 'settings' && state.role === 'parent') {
            $('setBalance').value = state.balance;
            $('setRate').value = state.pointsPerP;
            $('setInterest').value = state.interestRate;
            $('setLimit').value = state.interestLimit;
            $('setUnboxDate').value = state.unboxDate;
            $('poolInput').value = state.gachaPool.join('ã€');
            $('setFormUrl').value = state.formUrl;
        }
    };

    window.switchRole = (r) => { state.role = r; save(); };
    window.deleteWish = (id) => { if (confirm("ç¢ºå®šåˆªé™¤æ­¤é¡˜æœ›ï¼Ÿ")) { state.wishes = state.wishes.filter(w => w.id !== id); save(); } };
    window.resetAllData = () => { if (confirm("ğŸš¨ è­¦å‘Šï¼šé€™å°‡æ¸…é™¤æ‰€æœ‰æ•¸æ“šï¼ŒåŒ…å«é¡˜æœ›æ± ï¼")) { localStorage.removeItem(STORAGE_KEY); location.reload(); } };

    function resetPractice() {
        $('step-input').classList.remove('hidden'); $('step-decision').classList.add('hidden');
        $('itemPrice').value = ''; $('itemName').value = '';
        state.lastMode = null;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('mode-active'));
        showPage('vault');
    }

    function renderWishes() {
        $('wishList').innerHTML = state.wishes.map((w) => `
            <div class="card-dark border-l-4 border-blue-500 bg-blue-900/5">
                <div class="flex justify-between font-black text-sm mb-2"><span>${w.name}</span><span class="text-blue-400">$${w.saved} / $${w.price}</span></div>
                <div class="w-full bg-black h-4 rounded-full overflow-hidden border border-gray-800 mb-4 shadow-inner">
                    <div class="progress-bar bg-blue-500 h-full shadow-[0_0_10px_#3b82f6]" style="width:${Math.min(100, (w.saved / w.price) * 100)}%"></div>
                </div>
                <div class="flex gap-2">
                    <button onclick="injectMoney(${w.id})" class="flex-1 py-3 bg-blue-600/20 text-blue-400 rounded-xl text-xs font-black border border-blue-600/30">ğŸ’° æ³¨å…¥æ’²æ»¿è³‡é‡‘</button>
                    <button onclick="deleteWish(${w.id})" class="px-4 py-3 bg-red-900/10 text-red-500 rounded-xl text-xs border border-red-900/20">ğŸ—‘ï¸</button>
                </div>
            </div>`).join('');
    }

    function renderHistory() {
        $('historyList').innerHTML = state.logs.slice(0, 5).map(l => `
            <div class="card-dark p-3 text-[10px] flex justify-between border-gray-800 bg-black/20">
                <div class="flex flex-col">
                    <span class="text-gray-500">${l.time}</span>
                    <b class="text-orange-300 text-xs">${l.name}</b>
                </div>
                <div class="text-right flex flex-col justify-center">
                    <span class="text-gray-600 italic">${l.mode}</span>
                    <span class="${l.color} font-black text-base">${l.val}</span>
                </div>
            </div>`).join('');
    }

    document.addEventListener('DOMContentLoaded', updateUI);
</script>

</body>
</html>
