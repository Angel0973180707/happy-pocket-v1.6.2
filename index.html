<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>å¹¸ç¦æ•™é¤Šï½œé›¶ç”¨éŒ¢ç·´åŠŸæˆ¿ v1.6.2</title>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/272/272525.png">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
body { font-family: 'Noto Sans TC', sans-serif; background-color: #121212; color: #e5e7eb; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
.card-dark { background: #1a1a1a; border-radius: 1.5rem; padding: 1.25rem; border: 1px solid #262626; }
.input-dark-field { width: 100%; background: #000; border: 1px solid #333; border-radius: 1rem; padding: 0.8rem; color: white; outline: none; }
.btn-orange-dark { background: linear-gradient(135deg, #f97316, #ea580c); color: white; border-radius: 1.25rem; font-weight: 900; }
.nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; color: #404040; transition: 0.2s; }
.tab-active { color: #f97316; font-weight: bold; }
.mode-btn { padding: 0.6rem; border-radius: 0.8rem; background: #262626; color: #a3a3a3; font-size: 11px; border: 1px solid transparent; }
.mode-active { background: rgba(249, 115, 22, 0.1); color: #f97316; border-color: #f97316; }
.hidden { display: none !important; }
.progress-bar { transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }
</style>
</head>

<body class="pb-28">

<div class="p-4 flex justify-between items-center bg-[#1a1a1a] sticky top-0 z-50 h-20 border-b border-gray-800">
<div>
<p class="text-[10px] text-gray-500 font-bold">å¹¸ç¦æ•™é¤Šï½œé›¶ç”¨éŒ¢ç·´åŠŸæˆ¿</p>
<select id="roleSwitch" onchange="switchRole(this.value)" class="bg-black text-orange-500 font-black outline-none border-none cursor-pointer text-sm">
<option value="child">ğŸ‘¶ å…’ç«¥ç·´åŠŸæ¨¡å¼</option>
<option value="parent">âš™ï¸ å®¶é•·ç®¡ç†ä¸­å¿ƒ</option>
</select>
</div>
<div class="flex gap-4 font-black">
<span class="text-orange-500 text-sm">ğŸ’° $<span id="balanceDisplay">0</span></span>
<span class="text-blue-400 text-sm">ğŸ’ <span id="pointsDisplay">0</span>P</span>
</div>
</div>

<main class="p-4 max-w-md mx-auto">
<section id="page-info" class="page-content space-y-4">
<h1 class="text-xl font-black text-orange-500 italic uppercase">å¹¸ç¦æ•™é¤Šï½œé›¶ç”¨éŒ¢ç·´åŠŸæˆ¿</h1>
<div class="card-dark border-l-4 border-orange-500">
<h2 class="font-black text-orange-400 mb-2">ğŸ’¡ é›¶ç”¨éŒ¢ç·´åŠŸæˆ¿å®šç¾©</h2>
<div class="text-gray-400 text-[11px] leading-relaxed space-y-2">
<p>é€™æ˜¯ä¸€å€‹ç·´ç¿’<span class="text-white font-bold">ã€Œç†æ™ºæ¶ˆè²»ã€</span>çš„éŠæˆ²ã€‚é›¶ç”¨éŒ¢ä¸æ˜¯å–®ç´”çš„çµ¦äºˆï¼Œè€Œæ˜¯å­¸ç¿’è³‡æºåˆ†é…èˆ‡æƒ…ç·’æ§åˆ¶çš„å·¥å…·ã€‚</p>
<ul class="list-disc ml-4 space-y-1">
<li><span class="text-white">éœ€è¦ï¼š</span>ç”Ÿæ´»ä¸­ä¸å¯æˆ–ç¼ºçš„ï¼ˆå¦‚æ–‡å…·ï¼‰ã€‚</li>
<li><span class="text-white">æƒ³è¦ï¼š</span>ç›®å‰ä¸éœ€è¦ä½†æ“æœ‰æœƒé–‹å¿ƒçš„ï¼ˆå¦‚ç©å…·ï¼‰ã€‚</li>
<li><span class="text-blue-400">é¡˜æœ›ï¼š</span>éœ€è¦é•·æ™‚é–“å„²è“„æ‰èƒ½é”æˆçš„å¤¢æƒ³ã€‚</li>
</ul>
<p>é€éã€Œå†·éœæœŸã€ç·´ç¿’ï¼Œçœä¸‹ä¾†çš„éŒ¢æœƒè½‰åŒ–ç‚ºé»æ•¸ï¼Œè®“å­©å­åœ¨æ»¿è¶³ç‰©è³ªæ…¾æœ›å‰ï¼Œå…ˆæ”¶ç©«ç†æ™ºçš„æˆå°±æ„Ÿã€‚</p>
</div>
</div>
<div class="card-dark border-l-4 border-blue-500">
<h2 class="font-black text-blue-400 mb-2">ğŸ“² å®‰è£åˆ°æ‰‹æ©Ÿæ¡Œé¢</h2>
<div class="text-gray-400 text-[11px] leading-relaxed">
<p class="mb-2">å°‡æ­¤å·¥å…·ç¶²å€è²¼åˆ°ç€è¦½å™¨ä¸Šï¼Œé€²å…¥å¾Œæœƒçœ‹åˆ°å·¥å…·é é¢ï¼Œç„¶å¾Œé€²è¡Œä»¥ä¸‹æ“ä½œå³å¯å®‰è£ï¼š</p>
<div class="bg-black/50 p-3 rounded-lg border border-gray-800">
<p class="text-white font-bold mb-1">Apple Safari (iOS)ï¼š</p>
<p>é»æ“Šåº•éƒ¨å°è¦½åˆ—çš„ã€Œåˆ†äº«æŒ‰éˆ• (ç®­é ­å‘ä¸Š)ã€ï¼Œé¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€ã€‚</p>
<p class="text-white font-bold mt-2 mb-1">Android Chromeï¼š</p>
<p>é»æ“Šå³ä¸Šè§’ã€Œä¸‰å€‹é»ã€ï¼Œé¸æ“‡ã€Œå®‰è£æ‡‰ç”¨ç¨‹å¼ã€æˆ–ã€ŒåŠ å…¥ä¸»ç•«é¢ã€ã€‚</p>
</div>
</div>
</div>
<div class="card-dark border-l-4 border-yellow-500 text-sm">
<h2 class="font-black text-yellow-500 mb-1">ğŸ§˜ ä¿®ç·´è¦å‰‡</h2>
<ul class="text-gray-400 text-[11px] space-y-1">
<li>1. æƒ³æ¶ˆè²»æ™‚ï¼Œå¿…é ˆå…ˆå•Ÿå‹•ã€Œ30ç§’å†·éœæœŸã€ï¼Œè¨ˆåŠƒæ€§æ¶ˆè²»ç›´æ¥è¨˜éŒ„å³å¯ã€‚</li>
<li>2. æ±ºå®šä¸è²·æˆ–è€ƒæ…®ã€Œçœä¸‹ã€çš„é‡‘é¡å¯ç´¯ç©èƒ½é‡é»æ•¸ï¼ˆä¸€å…ƒ=1é»ï¼‰æ›på¹£ï¼ˆå¹¾é»æ›1på¯è‡ªè¡Œè¨­å®šï¼‰é ˜å–æ‰­è›‹ã€‚</li>
<li>3. æ±ºå®šçš„é¡åˆ¥ï¼ˆéœ€è¦/æƒ³è¦ï¼‰æœƒè¨˜éŒ„åœ¨é‡‘åº«æ—¥èªŒä¸­ã€‚é‡‘é¡å¤§ï¼Œé¤˜é¡ä¸è¶³çš„ï¼Œå…ˆæ”¾åˆ°é¡˜æœ›æ± å­µåŒ–ï¼Œæ…¢æ…¢å­˜æ¬¾å¯¦ç¾é¡˜æœ›</li>
<li>4. æ¯æœŸä½¿ç”¨å‰è«‹å…ˆåˆ°è¨­å®šå€é€²è¡Œå„é …è¨­å®š</li>
</ul>
</div>
</section>

<section id="page-vault" class="page-content hidden space-y-4">
<div class="card-dark text-center py-6 bg-gradient-to-b from-[#1a1a1a] to-[#251805] border-b-4 border-yellow-600 shadow-xl">
<p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Available Balance</p>
<p class="text-6xl font-black text-yellow-500 mb-4">$<span id="v-bal">0</span></p>
<div class="flex justify-center gap-2 text-[10px]">
<span class="bg-black/60 px-3 py-1 rounded-full text-blue-400 border border-blue-900/50 italic">èƒ½é‡: $<span id="v-saved">0</span></span>
<span class="bg-black/60 px-3 py-1 rounded-full text-orange-400 border border-orange-900/50 italic">é»æ•¸: <span id="v-pts">0</span>P</span>
</div>
</div>
<div class="card-dark border-l-4 border-purple-600 bg-purple-900/10 flex justify-between items-center py-4">
<div class="text-xs">
<p class="text-gray-400 font-bold uppercase">Settlement</p>
<p class="text-purple-400 font-black text-lg" id="v-date">æœªè¨­å®šæ—¥æœŸ</p>
</div>
<button onclick="checkUnboxPermission()" class="bg-purple-600 px-6 py-2 rounded-xl text-white font-black text-sm active:scale-95 transition-transform">çµç®—é–‹ç®±</button>
</div>
<button onclick="playGacha()" class="card-dark w-full border-2 border-orange-900 bg-orange-900/10 py-4 font-black text-orange-300 italic">ğŸ¡ èƒ½é‡æ‰­è›‹ (1P)</button>
<div class="space-y-2">
<h3 class="text-[10px] text-gray-500 font-black px-2 uppercase tracking-widest">Recent Activity</h3>
<div id="historyList" class="space-y-2"></div>
</div>
</section>

<section id="page-practice" class="page-content hidden">
<div class="card-dark text-center p-6 flex flex-col justify-center min-h-[350px]">
<div id="step-input">
<h2 class="text-xl font-black mb-4 text-orange-400 italic uppercase text-center">Training</h2>
<input type="text" id="itemName" class="input-dark-field mb-2 text-center" placeholder="æƒ³è²·ä»€éº¼ï¼Ÿ">
<input type="number" id="itemPrice" class="input-dark-field mb-6 text-3xl font-black text-center" placeholder="$">
<button onclick="startCooldown()" class="btn-orange-dark w-full py-4 text-lg mb-4 shadow-lg">ğŸ§˜ å•Ÿå‹• 30s å†·éœæœŸ</button>
<button onclick="quickSettle()" class="w-full py-2 text-gray-600 text-xs underline">âœ… è¨ˆç•«æ€§è³¼è²· (ä¸è¨ˆç·´åŠŸ)</button>
</div>
<div id="step-cooldown" class="hidden">
<div id="timerNum" class="text-8xl font-black text-orange-500 my-8 animate-pulse">30</div>
<p class="text-gray-500 italic tracking-widest text-center">å†·éœä¸­ï¼Œè«‹æ·±å‘¼å¸...</p>
</div>
<div id="step-decision" class="hidden">
<p class="text-gray-400 text-xs mb-4 italic text-center">å†·éœæ™‚é–“çµæŸï¼Œè«‹åˆ†é¡æ­¤é …ç›®ï¼š</p>
<div class="grid grid-cols-3 gap-2 mb-6">
<button onclick="setMode('éœ€è¦', this)" class="mode-btn">éœ€è¦</button>
<button onclick="setMode('æƒ³è¦', this)" class="mode-btn">æƒ³è¦</button>
<button onclick="setMode('é¡˜æœ›', this)" class="mode-btn border-blue-900/50 text-blue-400">âœ¨ é¡˜æœ›æ± </button>
</div>
<button id="save-energy-btn" onclick="saveDecision(false)" class="btn-orange-dark w-full py-4 mb-4 text-lg">çœä¸‹é‡‘é¡ï¼Œå„²å­˜èƒ½é‡ï¼</button>
<button onclick="saveDecision(true)" class="w-full text-gray-500 text-xs underline">æˆ‘æ±ºå®šè³¼è²·</button>
</div>
</div>
</section>

<section id="page-wish" class="page-content hidden space-y-4">
<h2 class="text-center text-xl font-black text-blue-400 italic uppercase">Wish Pool</h2>
<div id="wishList" class="space-y-4"></div>
</section>

<section id="page-settings" class="page-content hidden">
<div id="parent-settings" class="hidden space-y-4 text-xs">
<div class="card-dark border border-purple-900 space-y-3">
<h2 class="font-black text-purple-500 text-center mb-2 uppercase tracking-tighter">âš™ï¸ Management</h2>
<div><label class="text-gray-500">Google å›é¥‹è¡¨å–®é€£çµ</label><input type="text" id="setFormUrl" class="input-dark-field mt-1 text-blue-400"></div>
<div><label class="text-gray-500">ä¸‹ä¸€é–‹ç®±æ—¥æœŸ</label><input type="date" id="setUnboxDate" class="input-dark-field mt-1"></div>
<div class="grid grid-cols-2 gap-2">
<div><label class="text-gray-500">åŠ ç¢¼åˆ©æ¯ %</label><input type="number" id="setInterest" class="input-dark-field mt-1"></div>
<div><label class="text-gray-500">åŠ ç¢¼ä¸Šé™ $</label><input type="number" id="setLimit" class="input-dark-field mt-1"></div>
</div>
<div class="grid grid-cols-2 gap-2">
<div><label class="text-gray-500">é›¶ç”¨éŒ¢ï¼ˆå¯ç”¨é¤˜é¡ï¼‰</label><input type="number" id="setBalance" class="input-dark-field mt-1"></div>
<div><label class="text-gray-500">1P é»æ•¸åŒ¯ç‡ï¼ˆçœ1å…ƒ1é»ï¼Œå¹¾é»å¯æ›1pï¼‰</label><input type="number" id="setRate" class="input-dark-field mt-1"></div>
</div>
<div><label class="text-gray-500">æ‰­è›‹çé … (è¦ªå­å…±å‰µï¼Œå¯è¨­ç½®å¤šé …ï¼Œç”¨ã€Œã€ã€éš”é–‹)</label><textarea id="poolInput" class="input-dark-field h-16 mt-1 text-[10px]"></textarea></div>
<button onclick="saveSettings()" class="btn-orange-dark w-full py-4 mt-2">ğŸ’¾ å„²å­˜ä¸¦åŒæ­¥</button>
</div>
<div class="card-dark border border-red-900 bg-red-900/5 p-4 mt-4 text-center">
<button onclick="resetAllData()" class="w-full py-3 bg-red-600/20 text-red-500 border border-red-600 rounded-xl font-black">ğŸ—‘ï¸ å®Œæ•´é‡ç½®ç³»çµ±</button>
</div>
</div>
<div id="child-lock-msg" class="text-center p-20 text-gray-700 font-bold italic">ğŸ”’ ç®¡ç†åŠŸèƒ½å·²é–å®š</div>
</section>
</main>

<div id="unbox-modal" class="fixed inset-0 bg-black/98 z-[100] hidden flex flex-col p-6 overflow-y-auto">
<div id="settle-screen" class="flex-grow flex flex-col justify-center text-center space-y-6">
<h2 class="text-3xl font-black text-purple-400 italic">ğŸ é–‹ç®±çµç®—</h2>
<div class="card-dark space-y-4 bg-gray-900/50 border-purple-500/30">
<div class="flex justify-between"><span>æœ¬æœŸé¤˜é¡:</span><span class="text-white font-bold">$<span id="m-bal">0</span></span></div>
<div class="flex justify-between border-b border-gray-800 pb-2 text-green-400">
<span>åŠ ç¢¼åˆ©æ¯ (<span id="m-rate">0</span>%):</span>
<span class="font-bold">+$<span id="m-bonus">0</span></span>
</div>
<div class="flex justify-between text-2xl font-black text-yellow-500 pt-2"><span>æ‡‰é ˜ç¸½é¡:</span><span>$<span id="m-total">0</span></span></div>
</div>
<button onclick="finalSettle()" class="w-full bg-purple-600 text-white py-5 rounded-2xl font-black shadow-lg text-lg">ç¢ºèªçµç®—ä¸¦é‡ç½®é¤˜é¡</button>
<button onclick="$('unbox-modal').classList.add('hidden')" class="text-gray-600 text-xs underline">æš«æ™‚å–æ¶ˆ</button>
</div>
<div id="feedback-screen" class="hidden flex-grow flex flex-col justify-center text-center space-y-8">
<div class="text-6xl animate-bounce">ğŸ†</div>
<h2 class="text-3xl font-black text-yellow-500 italic">MISSION CLEAR</h2>
<p class="text-gray-400 leading-relaxed px-6">æ­å–œå®Œæˆä¿®ç·´ï¼è«‹é»æ“ŠæŒ‰éˆ•å¡«å¯«å›é¥‹å•å·ï¼Œé€™æ˜¯å„ªåŒ–å·¥å…·æœ€é‡è¦çš„æ•¸æ“šï¼š</p>
<button onclick="window.open(state.formUrl || 'https://forms.gle/A7c4bhmMzp9sdvWA7', '_blank')" class="btn-orange-dark w-full py-5 text-center text-lg shadow-2xl font-black border-2 border-yellow-400">ğŸ“ æäº¤å›é¥‹å•å·</button>
<button onclick="location.reload()" class="text-gray-600 text-sm underline italic">è¿”å›ä¸»ç•«é¢</button>
</div>
</div>

<nav class="fixed bottom-0 w-full bg-[#1a1a1a] border-t border-gray-800 flex justify-around p-3 h-24 z-50">
<button onclick="showPage('info')" class="nav-item tab-active" id="nav-info">ğŸ“–<span class="text-[10px] mt-1">èªªæ˜</span></button>
<button onclick="showPage('vault')" class="nav-item" id="nav-vault">ğŸ¯<span class="text-[10px] mt-1">é‡‘åº«</span></button>
<button onclick="showPage('practice')" class="nav-item" id="nav-practice">ğŸ§˜<span class="text-[10px] mt-1">ç·´åŠŸ</span></button>
<button onclick="showPage('wish')" class="nav-item" id="nav-wish">âœ¨<span class="text-[10px] mt-1">é¡˜æœ›æ± </span></button>
<button onclick="showPage('settings')" class="nav-item" id="nav-settings">âš™ï¸<span class="text-[10px] mt-1">è¨­å®š</span></button>
</nav>

<script>
const STORAGE_KEY = "hp_v163_final_restore";
const $ = (id) => document.getElementById(id);
let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
role: "child", balance: 0, savedAmount: 0, gachaCount: 0,
interestRate: 10, interestLimit: 100, unboxDate: "", pointsPerP: 100,
formUrl: "https://forms.gle/A7c4bhmMzp9sdvWA7",
logs: [], wishes: [], gachaPool: ["çœ‹é›»è¦–20åˆ†", "é¡å¤–é›¶å˜´", "æ™šç¡15åˆ†", "Switch 30åˆ†"]
};

function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); updateUI(); }

function updateUI() {
const currentP = Math.max(0, Math.floor(state.savedAmount / (state.pointsPerP || 100)) - state.gachaCount);
$('balanceDisplay').innerText = state.balance;
$('pointsDisplay').innerText = currentP;
$('v-bal').innerText = state.balance;
$('v-pts').innerText = currentP;
$('v-saved').innerText = state.savedAmount;
$('v-date').innerText = state.unboxDate || "æœªè¨­å®š";
$('parent-settings').classList.toggle('hidden', state.role !== "parent");
$('child-lock-msg').classList.toggle('hidden', state.role === "parent");
renderHistory(); renderWishes();
}

window.resetAllData = () => {
if(confirm("ğŸš¨ è­¦å‘Šï¼šé€™å°‡æœƒæ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼ç¢ºå®šè¦é‡ç½®å—ï¼Ÿ")) {
localStorage.removeItem(STORAGE_KEY);
location.reload();
}
};

window.checkUnboxPermission = () => {
if (state.role !== 'parent') return alert("çµç®—æ¬Šé™åƒ…é™å®¶é•·ã€‚");
const bonus = Math.min(Math.floor(state.balance * (state.interestRate / 100)), state.interestLimit);
$('m-bal').innerText = state.balance; $('m-rate').innerText = state.interestRate;
$('m-bonus').innerText = bonus; $('m-total').innerText = state.balance + bonus;
$('settle-screen').classList.remove('hidden'); $('feedback-screen').classList.add('hidden');
$('unbox-modal').classList.remove('hidden');
};

window.finalSettle = () => {
const total = $('m-total').innerText;
state.balance = 0; state.savedAmount = 0; state.gachaCount = 0;
state.logs.unshift({ time: new Date().toLocaleDateString(), name: "ğŸ† é–‹ç®±çµç®—", mode: "å®Œè³½", val: `$${total}`, color: "text-purple-400" });
save();
confetti({ particleCount: 200, spread: 80, origin: { y: 0.6 } });
$('settle-screen').classList.add('hidden');
$('feedback-screen').classList.remove('hidden');
};

window.showPage = (id) => {
document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
$('page-' + id).classList.remove('hidden');
document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('tab-active'));
$('nav-' + id).classList.add('tab-active');
if(id === 'settings' && state.role === 'parent') {
$('setBalance').value = state.balance; $('setRate').value = state.pointsPerP;
$('setInterest').value = state.interestRate; $('setLimit').value = state.interestLimit;
$('setUnboxDate').value = state.unboxDate; $('poolInput').value = state.gachaPool.join('ã€');
$('setFormUrl').value = state.formUrl;
}
};

window.startCooldown = () => {
if (!$('itemPrice').value || !$('itemName').value) return alert("è«‹å¡«å¯«é …ç›®èˆ‡é‡‘é¡");
$('step-input').classList.add('hidden'); $('step-cooldown').classList.remove('hidden');
let t = 30;
const timer = setInterval(() => {
t--; $('timerNum').innerText = t;
if (t <= 0) { clearInterval(timer); $('step-cooldown').classList.add('hidden'); $('step-decision').classList.remove('hidden'); }
}, 1000);
};

window.setMode = (m, btn) => {
state.lastMode = m;
document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('mode-active'));
btn.classList.add('mode-active');
$('save-energy-btn').innerText = (m === 'é¡˜æœ›') ? "âœ¨ åŠ å…¥é¡˜æœ›æ± " : "çœä¸‹é‡‘é¡ï¼Œå„²å­˜èƒ½é‡ï¼";
};

window.saveDecision = (buy) => {
if(!state.lastMode) return alert("è«‹é¸æ“‡åˆ†é¡");
const p = parseInt($('itemPrice').value); const n = $('itemName').value;
if (buy) {
if(state.balance < p) return alert("é¤˜é¡ä¸è¶³ï¼");
state.balance -= p;
state.logs.unshift({ time: new Date().toLocaleDateString(), name: n, mode: `è¡å‹•:${state.lastMode}`, action: "è³¼è²·", val: `-$${p}`, color: "text-red-500" });
} else {
if (state.lastMode === 'é¡˜æœ›') { state.wishes.unshift({ name: n, price: p, saved: 0 }); }
else { state.savedAmount += p; }
state.logs.unshift({ time: new Date().toLocaleDateString(), name: n, mode: `çœä¸‹:${state.lastMode}`, action: "çœéŒ¢", val: `+$${p}`, color: "text-blue-400" });
confetti({ particleCount: 100 });
}
save(); resetPractice();
};

window.quickSettle = () => {
const p = parseInt($('itemPrice').value); const n = $('itemName').value;
if (!p || !n || state.balance < p) return alert("é¤˜é¡ä¸è¶³æˆ–è³‡æ–™éŒ¯èª¤");
state.balance -= p;
state.logs.unshift({ time: new Date().toLocaleDateString(), name: `(è¨ˆç•«) ${n}`, mode: "è¨ˆç•«", action: "è³¼è²·", val: `-$${p}`, color: "text-gray-400" });
save(); resetPractice();
};

window.saveSettings = () => {
state.balance = parseInt($('setBalance').value) || 0;
state.pointsPerP = parseInt($('setRate').value) || 100;
state.interestRate = parseInt($('setInterest').value) || 0;
state.interestLimit = parseInt($('setLimit').value) || 0;
state.unboxDate = $('setUnboxDate').value;
state.formUrl = $('setFormUrl').value;
if($('poolInput').value) state.gachaPool = $('poolInput').value.split(/[ã€,]/);
save(); alert("è¨­å®šå„²å­˜æˆåŠŸï¼");
};

window.injectMoney = (i) => {
const amt = parseInt(prompt(`éŒ¢åŒ…å‰© $${state.balance}ï¼Œè¦å­˜å¤šå°‘åˆ° ${state.wishes[i].name}ï¼Ÿ`));
if (!amt || amt <= 0 || state.balance < amt) return alert("é‡‘é¡ç„¡æ•ˆ");
state.balance -= amt; state.wishes[i].saved += amt;
if (state.wishes[i].saved >= state.wishes[i].price) confetti({ particleCount: 200 });
save();
};

window.playGacha = () => {
const currentP = Math.floor(state.savedAmount / (state.pointsPerP || 100)) - state.gachaCount;
if(currentP < 1) return alert("èƒ½é‡é»æ•¸ä¸è¶³ï¼");
const prize = state.gachaPool[Math.floor(Math.random() * state.gachaPool.length)];
state.gachaCount++; save(); alert(`ğŸŠ æŠ½ä¸­çå‹µï¼šã€${prize}ã€‘`);
};

window.switchRole = (r) => { state.role = r; save(); };
window.deleteWish = (i) => { if(confirm("åˆªé™¤æ­¤é¡˜æœ›ï¼Ÿ")) { state.wishes.splice(i, 1); save(); } };

function resetPractice() { $('step-input').classList.remove('hidden'); $('step-decision').classList.add('hidden'); $('itemPrice').value = ''; $('itemName').value = ''; showPage('vault'); }

function renderWishes() {
$('wishList').innerHTML = state.wishes.map((w, i) => `
<div class="card-dark border-t-4 border-blue-500 bg-blue-900/5">
<div class="flex justify-between font-black text-xs mb-1"><span>${w.name}</span><span>$${w.saved}/$${w.price}</span></div>
<div class="w-full bg-black h-3 rounded-full overflow-hidden border border-gray-800 mb-3">
<div class="progress-bar bg-blue-500 h-full" style="width:${Math.min(100,(w.saved/w.price)*100)}%"></div>
</div>
<div class="flex gap-2"><button onclick="injectMoney(${i})" class="flex-1 py-2 bg-blue-600/20 text-blue-400 rounded-lg text-xs font-black">ğŸ’° æ³¨å…¥</button><button onclick="deleteWish(${i})" class="px-3 py-2 bg-red-900/10 text-red-500 rounded-lg text-xs">ğŸ—‘ï¸</button></div>
</div>`).join('');
}

function renderHistory() {
$('historyList').innerHTML = state.logs.slice(0, 5).map(l => `
<div class="card-dark p-3 text-[10px] flex justify-between border-gray-800">
<span>${l.time} <b class="ml-2 text-orange-300">${l.name}</b></span>
<span class="${l.color} font-black">${l.val}</span>
</div>`).join('');
}

// è¨»å†Š Service Worker (PWA å®‰è£é—œéµ)
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('PWA Service Worker å·²å°±ç·’'))
            .catch(err => console.log('SW è¨»å†Šå¤±æ•—', err));
    });
}

document.addEventListener('DOMContentLoaded', updateUI);
</script>
</body>
</html>
